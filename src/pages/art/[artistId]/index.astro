---
import LayoutWithHeader from "@layouts/LayoutWithHeader.astro";
import ArtStatusBadge from "@components/ArtStatusBadge.astro";
import { ArtistDescription } from "@components/ArtistDescription";
import {
  getArtistById,
  getArtsByArtistId,
  getAuthDataBySessionId,
} from "@lib/server";

const { artistId } = Astro.params;

if (typeof artistId !== "string") {
  return Astro.redirect("/500");
}

const [artist, arts] = await Promise.all([
  getArtistById(artistId),
  getArtsByArtistId(artistId),
]);

if (artist === undefined) {
  return Astro.redirect("/404");
}

const { isAuthed, artist: authData } = await getAuthDataBySessionId(
  Astro.cookies.get("session").value
);

const isMyProfile = isAuthed && authData && authData.artistId === artistId;
---

<LayoutWithHeader title={`${artist.name}`}>
  <div class="h-8"></div>
  <img
    class="w-full rounded-lg top-0 left-0 h-[240px] object-cover -z-10 bg-gradient-to-b"
    src={`/image?id=header-${artist.id}`}
  />
  <div class="relative w-full">
    <img
      src={artist.picture}
      class="h-20 w-20 absolute -top-10 left-4 rounded-full border-2 border-black dark:border-white p-[1px] object-cover"
    />
    <div
      class="flex gap-4 justify-end w-full mt-2 pl-28 opacity-0 flex-wrap"
      class:list={{ "opacity-100": isMyProfile }}
    >
      <a href="/art/new" class="rounded-full border-[1px] px-2 py-1 btn">
        작품 추가하기
      </a>
      <a href="/me/profile" class="rounded-full border-[1px] px-2 py-1 btn">
        프로필 수정하기
      </a>
    </div>
  </div>
  <div class="flex flex-col mt-4 w-full px-4">
    <div class="text-2xl font-bold mb-2">{artist.name}</div>
    <ArtistDescription
      description={artist.description}
      history={artist.history}
      client:load
    />
    <p class="text-lg font-bold mt-10">작품 목록</p>
    <div class="flex flex-col gap-8 mt-4 items-start">
      {
        arts.map(({ id, name, description, thumbnail, price, status }) => (
          <div class="w-full flex gap-4 rounded-lg border-2 p-4 relative flex-col md:flex-row md:items-start items-center">
            <div class="bg-opacity-20 w-full max-w-[400px] h-[200px] flex justify-center">
              <img
                src={`/image?id=${thumbnail}`}
                class="w-[300px] object-contain"
              />
            </div>
            <div class="flex flex-col gap-2 w-full">
              <div class="flex w-full justify-between items-end flex-wrap">
                <a
                  href={`/art/${artistId}/${id}`}
                  class="font-extrabold text-xl"
                >
                  {name}
                </a>
                <p />
                {price ? <p>{price} &#8361; </p> : <p>가격 미정</p>}
              </div>

              <p class="text-sm">{description}</p>
            </div>
            <div class="absolute bottom-0 right-0 m-4">
              <ArtStatusBadge status={status} />
            </div>
          </div>
        ))
      }
    </div>
    {
      arts.length === 0 && (
        <div class="self-center text-gray-500 mt-10">작품 없음</div>
      )
    }
  </div>
</LayoutWithHeader>
